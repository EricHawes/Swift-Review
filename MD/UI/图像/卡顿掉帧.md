## 卡顿掉帧的原因？卡顿掉帧应该怎么优化？

#### 卡顿掉帧的原因？

![](https://github.com/RayJiang16/Swift-Review/blob/master/Image/UI/screen-fps.png)

在显示器中是固定的频率，在 iOS 中是每秒 60 帧（60 FPS），即每帧 16.7 ms。

从上图中可以看出，每两个 VSync 信号之间有时间间隔（16.7 ms），在这个时间内，CPU 主线程计算布局，解码图片，创建视图，绘制文本，计算完成后将内容交给 GPU，GPU 变换，合成，渲染，放入帧缓冲区。

假如16.7ms内，CPU和GPU没有来得及生产出一帧缓冲，那么这一帧会被丢弃，显示器就会保持不变，继续显示上一帧内容，这就将导致导致画面卡顿。



#### 卡顿掉帧应该怎么优化？

##### CPU

1. 部分对象的创建、调整和销毁可以放到子线程去做
2. 预排版（ 布局计算、文本计算），这些计算也可以放到子线程去做，这样主线程也可以有更多的时间去响应用户的交互
3. 预渲染（文本等异步绘制、图片编解码等）

##### GPU

1. **纹理渲染**：假如说我们触发了**离屏渲染**，例如我们设置圆角时对maskToBounds的设置，包括一些阴影、蒙层等都会触发GPU层面的离屏渲染，对于这种情况下，GPU对于纹理渲染的工作量就会非常的大，我们可以基于此对GPU进行优化，就是**尽量减少离屏渲染**，我们也可以**通过CPU的异步绘制来减轻GPU的压力**
2. **视图混合**： 比如说我们视图层级比较复杂，视图之间层层叠加，那么GPU就要做每一个视图的合成，合成每一个像素点的像素值，如果我们可以**减少视图的层级**，也是可以减轻GPU的压力，我们也可以**通过CPU的异步绘制机制来达到一个提交的位图本身就是一个层级比较少的位图**



#### Reference

https://juejin.im/post/5c0931d451882531b81b20fa#heading-4